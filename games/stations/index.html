<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ° ××©×™××ª ×¤×•×¨×™× â€” ×—×“×¨×™ ×”××ª×’×¨</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700;900&family=Heebo:wght@300;400;700;900&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Heebo', sans-serif;
      background: linear-gradient(180deg, #fef9ef, #fdf4ff);
      color: #1e1b4b; min-height: 100vh; padding: 20px 20px 220px;
    }
    .back-link {
      position: fixed; top: 12px; right: 12px;
      color: #7c3aed; text-decoration: none; font-size: 0.85rem;
      background: #fff; padding: 5px 12px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100;
    }
    h1 { font-family: 'Frank Ruhl Libre', serif; text-align: center; font-size: 2rem; color: #7c3aed; margin: 10px 0 5px; }
    .subtitle { text-align: center; color: #6b7280; margin-bottom: 10px; }

    /* â•â• Teacher Setup â•â• */
    .setup-bar {
      max-width: 700px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #ede9fe, #f3e8ff);
      border: 2px solid #c084fc; border-radius: 16px;
      padding: 14px 20px;
      display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;
    }
    .setup-bar label { font-size: 0.85rem; font-weight: 700; color: #4c1d95; }
    .setup-bar input {
      width: 60px; padding: 6px 10px; border: 2px solid #c084fc; border-radius: 8px;
      font-size: 1rem; text-align: center; font-weight: 700; color: #4c1d95; background: #fff;
    }
    .setup-bar .save-btn {
      background: #7c3aed; color: #fff; border: none; padding: 8px 20px;
      border-radius: 10px; font-family: 'Heebo', sans-serif; font-weight: 700;
      cursor: pointer; font-size: 0.85rem; transition: all 0.3s;
    }
    .setup-bar .save-btn:hover { background: #6d28d9; transform: translateY(-1px); }
    .setup-bar .reset-data-btn {
      background: none; color: #ef4444; border: 1px solid #ef4444; padding: 6px 14px;
      border-radius: 8px; font-family: 'Heebo', sans-serif; font-size: 0.75rem;
      cursor: pointer; transition: all 0.3s;
    }
    .setup-bar .reset-data-btn:hover { background: #fef2f2; }

    /* â•â• Color Tip â•â• */
    .color-tip {
      max-width: 700px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      border: 2px solid #fbbf24; border-radius: 16px;
      padding: 12px 20px; text-align: center;
    }
    .color-tip h3 { color: #b45309; font-size: 1rem; margin: 4px 0; }
    .color-tip p { color: #92400e; font-size: 0.85rem; line-height: 1.5; }

    /* â•â• Room Cards â•â• */
    .rooms { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
    .room-card {
      display: flex; align-items: center; gap: 15px;
      background: #fff; border: 2px solid #e9d5ff;
      border-radius: 16px; padding: 14px 18px;
      text-decoration: none; color: inherit;
      transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      position: relative;
    }
    .room-card:hover { transform: translateX(-5px); border-color: #c084fc; box-shadow: 0 6px 20px rgba(124,58,237,0.12); }
    .room-card.locked {
      opacity: 0.5; pointer-events: none; filter: grayscale(0.5);
    }
    .room-emoji { font-size: 2.2rem; min-width: 45px; text-align: center; }
    .room-info { flex: 1; }
    .room-title { font-family: 'Frank Ruhl Libre', serif; font-size: 1.1rem; color: #4c1d95; }
    .room-desc { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
    .room-color {
      display: inline-block; padding: 2px 8px;
      border-radius: 6px; font-size: 0.7rem; font-weight: 700;
      margin-top: 4px;
    }
    .room-arrow { font-size: 1.5rem; color: #c084fc; }
    .room-lock { position: absolute; top: 8px; left: 8px; font-size: 1.2rem; }
    .room-progress {
      position: absolute; bottom: 6px; left: 10px;
      font-size: 0.7rem; color: #9ca3af; font-weight: 700;
    }

    /* â•â• Always-Visible Progress Panel â•â• */
    .progress-section {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
      background: #fff; border-top: 3px solid #7c3aed;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      transition: max-height 0.4s ease;
      max-height: 50px; overflow: hidden;
    }
    .progress-section.expanded { max-height: 60vh; overflow-y: auto; }

    .progress-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 20px; cursor: pointer; user-select: none;
    }
    .progress-header h3 {
      font-family: 'Frank Ruhl Libre', serif; color: #4c1d95;
      font-size: 1rem; margin: 0; display: flex; align-items: center; gap: 8px;
    }
    .progress-header .badge {
      background: #7c3aed; color: #fff; border-radius: 12px; padding: 2px 10px;
      font-size: 0.75rem; font-weight: 900;
    }
    .progress-header .toggle-arrow {
      font-size: 1.2rem; color: #7c3aed; transition: transform 0.3s;
    }
    .progress-section.expanded .toggle-arrow { transform: rotate(180deg); }

    .progress-body { padding: 0 16px 16px; }

    .progress-table {
      width: 100%; border-collapse: collapse; font-size: 0.75rem; direction: rtl;
    }
    .progress-table th {
      background: #f3e8ff; color: #4c1d95; padding: 5px 3px;
      font-weight: 700; border: 1px solid #e9d5ff; white-space: nowrap;
    }
    .progress-table td {
      text-align: center; padding: 4px 3px; border: 1px solid #f0e6ff;
    }
    .progress-table tr:nth-child(even) { background: #faf5ff; }
    .progress-table .group-header {
      font-weight: 900; color: #7c3aed; background: #ede9fe;
      padding: 6px 8px; cursor: pointer;
    }
    .progress-table .group-header:hover { background: #ddd6fe; }
    .progress-table .member-row { font-size: 0.7rem; }
    .progress-table .member-row td:first-child { color: #6b7280; padding-right: 20px; }
    .progress-table .pct-cell { font-weight: 900; }
    .pct-green { color: #16a34a; }
    .pct-yellow { color: #ca8a04; }
    .pct-red { color: #dc2626; }

    .progress-empty {
      text-align: center; color: #9ca3af; padding: 20px; font-size: 0.9rem;
    }

    /* â•â• Leaderboard â•â• */
    .leaderboard {
      max-width: 700px; margin: 20px auto 0;
      background: linear-gradient(135deg, #fef9c3, #fffbeb);
      border: 2px solid #fbbf24; border-radius: 16px;
      padding: 16px 20px;
    }
    .leaderboard h2 {
      font-family: 'Frank Ruhl Libre', serif; text-align: center;
      color: #92400e; font-size: 1.3rem; margin-bottom: 12px;
    }
    .lb-row {
      display: flex; align-items: center; gap: 12px;
      padding: 8px 14px; border-radius: 10px;
      margin-bottom: 6px; transition: all 0.3s;
    }
    .lb-row:nth-child(1) { background: linear-gradient(135deg, #fef08a, #fde047); }
    .lb-row:nth-child(2) { background: linear-gradient(135deg, #e5e7eb, #d1d5db); }
    .lb-row:nth-child(3) { background: linear-gradient(135deg, #fed7aa, #fdba74); }
    .lb-row:nth-child(n+4) { background: rgba(255,255,255,0.6); }
    .lb-medal { font-size: 1.5rem; min-width: 30px; text-align: center; }
    .lb-group { font-weight: 900; color: #4c1d95; font-size: 1rem; flex: 1; }
    .lb-score { font-weight: 900; color: #92400e; font-size: 1.1rem; }
    .lb-empty { text-align: center; color: #9ca3af; padding: 12px; font-size: 0.9rem; }

    @media (max-width: 600px) {
      body { padding: 15px 10px 210px; }
      .setup-bar { gap: 8px; padding: 10px 12px; }
      .progress-table { font-size: 0.65rem; }
      .room-card { padding: 12px 14px; gap: 10px; }
    }
  </style>
</head>
<body>
<a href="../../index.html" class="back-link">â†’ ×—×–×¨×”</a>
<h1>ğŸ° ××©×™××ª ×¤×•×¨×™×</h1>
<p class="subtitle">×—×“×¨×™ ××ª×’×¨ ××”××’×™×œ×” â€” ×œ×©×—×§ ×‘×‘×™×ª!</p>

<!-- â•â• Room Gate â•â• -->
<div id="roomGate" style="max-width:400px; margin:40px auto; text-align:center; background:#fff; padding:30px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,0.08);">
  <div style="font-size:3rem; margin-bottom:10px;">ğŸ«</div>
  <h2 style="font-family:'Frank Ruhl Libre',serif; color:#4c1d95; margin-bottom:15px;">×”×›× ×™×¡×• ×§×•×“ ×—×“×¨</h2>
  <input id="roomInput" type="text" placeholder="×œ×“×•×’××”: 101" style="font-family:'Heebo',sans-serif; font-size:1.5rem; padding:12px 20px; border:3px solid #c084fc; border-radius:14px; text-align:center; width:200px; color:#4c1d95; font-weight:900;" onkeydown="if(event.key==='Enter')enterRoom()">
  <br>
  <button onclick="enterRoom()" style="font-family:'Heebo',sans-serif; margin-top:12px; padding:12px 40px; background:linear-gradient(135deg,#7c3aed,#ec4899); color:#fff; border:none; border-radius:14px; font-size:1.1rem; font-weight:700; cursor:pointer;">ğŸš€ ×›× ×¡×•!</button>
</div>

<div id="mainContent" style="display:none;">

<!-- â•â• Teacher Setup â•â• -->
<div style="max-width:700px; margin:0 auto 10px; text-align:center;">
  <button onclick="teacherLogin()" style="font-family:'Heebo',sans-serif; font-size:0.85rem; padding:6px 18px; background:rgba(124,58,237,0.08); border:1px solid rgba(124,58,237,0.25); color:#7c3aed; border-radius:10px; cursor:pointer;">ğŸ” ×›× ×™×¡×ª ××•×¨×”</button>
</div>
<div class="setup-bar" id="setupBar" style="display:none;">
  <label>âš™ï¸ ×”×’×“×¨×ª ××•×¨×”:</label>
  <label>×ª×œ××™×“×™× <input type="number" id="numStudents" min="1" max="100" value="30"></label>
  <label>×‘×§×‘×•×¦×” <input type="number" id="groupSize" min="2" max="15" value="5"></label>
  <button class="save-btn" onclick="saveSettings()">ğŸ’¾ ×©××•×¨</button>
  <button class="reset-data-btn" onclick="resetAllData()">ğŸ—‘ï¸ ××¤×¡ × ×ª×•× ×™×</button>
</div>

<!-- â•â• Color Tip â•â• -->
<div class="color-tip">
  <h3>ğŸ¨ ×”×›× ×” ×œ×¤× ×™ ×”××©×—×§!</h3>
  <p>
    ×›×œ ×—×“×¨ ××ª×—×™×œ ×‘×©×œ×‘ ×¦×‘×¢ â€” <strong>×¦×‘×¢×• ×“×£ ×œ×‘×Ÿ ×‘×¦×‘×¢ ×”××ª××™×</strong> ×•×”×¨×™××• ×œ××¦×œ××” ğŸ“·<br>
    <strong>âš ï¸ 80% ××”×§×‘×•×¦×” ×—×™×™×‘×™× ×œ×¡×™×™× ×—×“×¨ ×œ×¤× ×™ ×©× ×¤×ª×— ×”×‘×!</strong>
  </p>
</div>

<!-- â•â• Rooms â•â• -->
<div class="rooms" id="roomsList">
  <a href="station-3-scratch.html" class="room-card" data-station="3">
    <span class="room-emoji">ğŸ«</span>
    <div class="room-info">
      <div class="room-title">×—×“×¨ ×”×’×™×¨×•×“</div>
      <div class="room-desc">×’×¨×“×• ××ª ×”×›×¨×˜×™×¡×™× ×•×’×œ×• ×¡×•×“×•×ª!</div>
      <span class="room-color" style="background:#dbeafe; color:#1e40af;">ğŸ”µ ×¦×‘×¢×• ×‘×¦×‘×¢ ×›×—×•×œ</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>

  <a href="station-5-haman.html" class="room-card" data-station="5">
    <span class="room-emoji">ğŸ”¨</span>
    <div class="room-info">
      <div class="room-title">×”×›×• ×‘×”××Ÿ!</div>
      <div class="room-desc">×¦×¢×§×• ×—×–×§ ×›×›×œ ×”××¤×©×¨ â€” ××©×—×§ ×§×•×œ ××˜×•×¨×£!</div>
      <span class="room-color" style="background:#fef9c3; color:#854d0e;">ğŸŸ¡ ×¦×‘×¢×• ×‘×¦×‘×¢ ×¦×”×•×‘</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>

  <a href="station-4-letters.html" class="room-card" data-station="4">
    <span class="room-emoji">ğŸ”¤</span>
    <div class="room-info">
      <div class="room-title">×—×“×¨ ×”××•×ª×™×•×ª</div>
      <div class="room-desc">×¤×¢× ×—×• ××ª ×”×¦×•×¤×Ÿ ×”×¡×•×“×™ â€” ××™ ××¡×ª×ª×¨ ×‘×™×Ÿ ×”××•×ª×™×•×ª?</div>
      <span class="room-color" style="background:#dcfce7; color:#166534;">ğŸŸ¢ ×¦×‘×¢×• ×‘×¦×‘×¢ ×™×¨×•×§</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>

  <a href="station-1-flashlight.html" class="room-card" data-station="1">
    <span class="room-emoji">ğŸ”¦</span>
    <div class="room-info">
      <div class="room-title">×—×“×¨ ×”×¡× ×¤×™×¨</div>
      <div class="room-desc">××¦××• ××™×œ×™× × ×¡×ª×¨×•×ª ×‘×—×•×©×š ×¢× ×¤× ×¡!</div>
      <span class="room-color" style="background:#fee2e2; color:#991b1b;">ğŸ”´ ×¦×‘×¢×• ×‘×¦×‘×¢ ××“×•×</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>

  <a href="station-6-temperature.html" class="room-card" data-station="6">
    <span class="room-emoji">ğŸŒ¡ï¸</span>
    <div class="room-info">
      <div class="room-title">×—×“×¨ ×”×˜××¤×¨×˜×•×¨×”</div>
      <div class="room-desc">×—× ××• ×§×¨? ×›×•×•× ×• ××ª ×”××¡× × ×™× ×•×’×œ×• ××ª ×”×¤×¡×•×§!</div>
      <span class="room-color" style="background:#ffedd5; color:#9a3412;">ğŸŸ  ×¦×‘×¢×• ×‘×¦×‘×¢ ×›×ª×•×</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>

  <a href="station-2-photo.html" class="room-card" data-station="2">
    <span class="room-emoji">ğŸ“¸</span>
    <div class="room-info">
      <div class="room-title">×—×“×¨ ×”×¦×™×œ×•× ×”××œ×›×•×ª×™</div>
      <div class="room-desc">ğŸ† ×”××©×™××” ×”××—×¨×•× ×”! ×¦×œ××• ×ª××•× ×” ×§×‘×•×¦×ª×™×ª ×—×’×™×’×™×ª</div>
      <span class="room-color" style="background:#dbeafe; color:#1e40af;">ğŸ“· ××©×™××” ××—×¨×•× ×” â€” ×œ×œ× ×¦×‘×¢</span>
    </div>
    <span class="room-arrow">â†</span>
  </a>
</div>

<!-- â•â• Leaderboard â•â• -->
<div class="leaderboard" id="leaderboard">
  <h2>ğŸ† ×˜×‘×œ×ª ×”××•×‘×™×œ×™×</h2>
  <div id="leaderboard-content"></div>
</div>

<!-- â•â• Always-Visible Progress Panel â•â• -->
<div class="progress-section" id="progressSection">
  <div class="progress-header" onclick="toggleProgress()">
    <h3>ğŸ“Š ×”×ª×§×“××•×ª <span class="badge" id="progressBadge">×˜×•×¢×Ÿ...</span></h3>
    <span class="toggle-arrow">â–²</span>
  </div>
  <div class="progress-body" id="progressBody"></div>
</div>

</div><!-- end mainContent -->

<script>
  // â•â• Room Code System â•â•
  const ROOM = new URLSearchParams(window.location.search).get('room') || '';
  const K = ROOM ? ROOM + '_' : ''; // localStorage key prefix

  function enterRoom() {
    const code = document.getElementById('roomInput').value.trim();
    if (!code) { alert('×”×›× ×™×¡×• ×§×•×“ ×—×“×¨'); return; }
    window.location.href = '?room=' + encodeURIComponent(code);
  }

  if (ROOM) {
    document.getElementById('roomGate').style.display = 'none';
    document.getElementById('mainContent').style.display = '';
    document.querySelector('.subtitle').textContent = `×—×“×¨: ${ROOM}`;
    // Update station links with room param
    document.querySelectorAll('.room-card').forEach(a => {
      a.href = a.href.split('?')[0] + '?room=' + encodeURIComponent(ROOM);
    });
  }

  const STATIONS = [
    { id: 1, emoji: 'ğŸ«', name: '×’×™×¨×•×“' },
    { id: 2, emoji: 'ğŸ”¨', name: '×”××Ÿ' },
    { id: 3, emoji: 'ğŸ”¤', name: '××•×ª×™×•×ª' },
    { id: 4, emoji: 'ğŸ”¦', name: '×¡× ×¤×™×¨' },
    { id: 5, emoji: 'ğŸŒ¡ï¸', name: '×˜××¤×¨×˜×•×¨×”' },
    { id: 6, emoji: 'ğŸ“¸', name: '×¦×™×œ×•×' },
  ];
  const STATION_ORDER = [1, 2, 3, 4, 5, 6];

  // â•â• Teacher Auth â•â•
  const TEACHER_PASS = '1234';
  function teacherLogin() {
    const pass = prompt('ğŸ” ×”×›× ×™×¡×• ×§×•×“ ××•×¨×”:');
    if (pass === TEACHER_PASS) {
      sessionStorage.setItem('purim_teacher', '1');
      document.getElementById('setupBar').style.display = '';
    } else if (pass !== null) {
      alert('âŒ ×¡×™×¡××” ×©×’×•×™×”');
    }
  }
  if (sessionStorage.getItem('purim_teacher') === '1') {
    document.getElementById('setupBar').style.display = '';
  }

  // â•â• Firebase Sync â•â•
  const FB = 'https://moria-1d5c0-default-rtdb.europe-west1.firebasedatabase.app/purim';
  function fbPut(path, val) { if (!ROOM) return; fetch(`${FB}/${encodeURIComponent(ROOM)}/${path}.json`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(val) }).catch(()=>{}); }

  async function syncFromFirebase() {
    if (!ROOM) return;
    try {
      const r = await fetch(`${FB}/${encodeURIComponent(ROOM)}.json`);
      const fb = await r.json();
      if (!fb) return;
      // Merge progress
      if (fb.progress) {
        const local = JSON.parse(localStorage.getItem(K + 'purim_progress') || '{}');
        for (const [g, members] of Object.entries(fb.progress)) {
          if (!local[g]) local[g] = {};
          for (const [m, stations] of Object.entries(members || {})) {
            if (!local[g][m]) local[g][m] = [];
            if (typeof stations === 'object' && !Array.isArray(stations)) {
              for (const s of Object.keys(stations)) { const n = parseInt(s); if (!local[g][m].includes(n)) local[g][m].push(n); }
            }
          }
        }
        localStorage.setItem(K + 'purim_progress', JSON.stringify(local));
      }
      // Merge scores
      if (fb.scores) {
        const local = JSON.parse(localStorage.getItem(K + 'purim_scores') || '{}');
        for (const [g, ss] of Object.entries(fb.scores)) {
          if (!local[g]) local[g] = {};
          for (const [s, sc] of Object.entries(ss || {})) { local[g][s] = Math.max(local[g][s] || 0, sc); }
        }
        localStorage.setItem(K + 'purim_scores', JSON.stringify(local));
      }
      // Settings
      if (fb.settings) {
        localStorage.setItem(K + 'purim_settings', JSON.stringify(fb.settings));
      }
    } catch {}
  }

  // â•â• Settings â•â•
  function getSettings() {
    const s = JSON.parse(localStorage.getItem(K + 'purim_settings') || '{}');
    const numStudents = s.numStudents || 30;
    const groupSize = s.groupSize || 5;
    const numGroups = Math.ceil(numStudents / groupSize);
    return { numStudents, groupSize, numGroups };
  }

  function loadSettings() {
    const s = getSettings();
    document.getElementById('numStudents').value = s.numStudents;
    document.getElementById('groupSize').value = s.groupSize;
  }

  function saveSettings() {
    const numStudents = Math.max(1, Math.min(100, parseInt(document.getElementById('numStudents').value) || 30));
    const groupSize = Math.max(2, Math.min(15, parseInt(document.getElementById('groupSize').value) || 5));
    const numGroups = Math.ceil(numStudents / groupSize);
    const settingsObj = { numStudents, groupSize, numGroups };
    localStorage.setItem(K + 'purim_settings', JSON.stringify(settingsObj));
    fbPut('settings', settingsObj);
    document.getElementById('numStudents').value = numStudents;
    document.getElementById('groupSize').value = groupSize;
    renderProgress();
    alert(`âœ… × ×©××¨! ${numStudents} ×ª×œ××™×“×™× â†’ ${numGroups} ×§×‘×•×¦×•×ª (${groupSize} ×‘×›×œ ×§×‘×•×¦×”)`);
  }

  function resetAllData() {
    if (confirm('âš ï¸ ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”×”×ª×§×“××•×ª ×•×”× ×™×§×•×“?')) {
      localStorage.removeItem(K + 'purim_progress');
      localStorage.removeItem(K + 'purim_scores');
      fbPut('progress', null);
      fbPut('scores', null);
      renderProgress();
      renderLeaderboard();
    }
  }

  // â•â• Progress â•â•
  function toggleProgress() {
    document.getElementById('progressSection').classList.toggle('expanded');
  }

  function getGroupCompletion(groupData, stationId) {
    if (!groupData || typeof groupData !== 'object') return { done: 0, total: 0, pct: 0 };
    const members = Object.keys(groupData);
    let done = 0;
    members.forEach(m => {
      const memberStations = groupData[m] || [];
      if (memberStations.includes(stationId)) done++;
    });
    const total = members.length || 1;
    return { done, total, pct: (done / total * 100) };
  }

  function renderProgress() {
    const data = JSON.parse(localStorage.getItem(K + 'purim_progress') || '{}');
    const s = getSettings();
    const body = document.getElementById('progressBody');

    const activeGroups = [];
    for (let g = 1; g <= s.numGroups; g++) {
      if (data[String(g)] && Object.keys(data[String(g)]).length > 0) {
        activeGroups.push(String(g));
      }
    }

    if (activeGroups.length === 0) {
      body.innerHTML = '<div class="progress-empty">ğŸ ×¢×“×™×™×Ÿ ××™×Ÿ ×”×ª×§×“××•×ª â€” ×©×œ×—×• ××ª ×”×§×‘×•×¦×•×ª!</div>';
      document.getElementById('progressBadge').textContent = '0 ×§×‘×•×¦×•×ª';
      updateRoomLocks(data, s);
      return;
    }

    let html = '<table class="progress-table"><thead><tr><th></th>';
    STATIONS.forEach(st => { html += `<th>${st.emoji}<br>${st.name}</th>`; });
    html += '</tr></thead><tbody>';

    let totalDoneAll = 0;

    const scores = JSON.parse(localStorage.getItem(K + 'purim_scores') || '{}');
    activeGroups.forEach(g => {
      const gData = data[g] || {};
      const gScore = scores[g] ? Object.values(scores[g]).reduce((a,b) => a + (b||0), 0) : 0;
      const scoreLabel = gScore > 0 ? ` <span style="color:#ffd700;font-size:0.85em;">â­${gScore}</span>` : '';
      html += `<tr><td class="group-header" onclick="toggleGroupDetail('group-${g}')">ğŸ‘¥ ×§×‘×•×¦×” ${g}${scoreLabel} â–¾</td>`;
      STATIONS.forEach(st => {
        const comp = getGroupCompletion(gData, st.id);
        const pctClass = comp.pct >= 80 ? 'pct-green' : comp.pct >= 40 ? 'pct-yellow' : 'pct-red';
        const icon = comp.pct >= 80 ? 'âœ…' : `${comp.done}/${comp.total}`;
        html += `<td class="pct-cell ${pctClass}">${icon}</td>`;
        if (comp.pct >= 80) totalDoneAll++;
      });
      html += '</tr>';

      for (const [memberName, memberStations] of Object.entries(gData)) {
        html += `<tr class="member-row group-${g}" style="display:none"><td>  ${memberName}</td>`;
        STATIONS.forEach(st => {
          html += `<td>${(memberStations || []).includes(st.id) ? 'âœ…' : 'â¬œ'}</td>`;
        });
        html += '</tr>';
      }
    });

    html += '</tbody></table>';
    body.innerHTML = html;
    document.getElementById('progressBadge').textContent = `${activeGroups.length} ×§×‘×•×¦×•×ª`;
    updateRoomLocks(data, s);
  }

  function toggleGroupDetail(className) {
    document.querySelectorAll(`.${className}`).forEach(row => {
      row.style.display = row.style.display === 'none' ? '' : 'none';
    });
  }

  // â•â• 80% Gate â€” Lock rooms â•â•
  function updateRoomLocks(data, settings) {
    const cards = document.querySelectorAll('.room-card[data-station]');
    cards.forEach((card, idx) => {
      card.classList.remove('locked');
      const existingLock = card.querySelector('.room-lock');
      if (existingLock) existingLock.remove();
      const existingProg = card.querySelector('.room-progress');
      if (existingProg) existingProg.remove();
      if (idx === 0) return;
    });
  }

  // â•â• Leaderboard â•â•
  function renderLeaderboard() {
    const scores = JSON.parse(localStorage.getItem(K + 'purim_scores') || '{}');
    const content = document.getElementById('leaderboard-content');

    const entries = [];
    for (const [g, stationScores] of Object.entries(scores)) {
      let total = 0;
      for (const s of Object.values(stationScores)) total += (s || 0);
      if (total > 0) entries.push({ group: g, total });
    }

    if (entries.length === 0) {
      content.innerHTML = '<div class="lb-empty">ğŸ ×¢×“×™×™×Ÿ ××™×Ÿ × ×™×§×•×“ â€” ×©×œ×—×• ××ª ×”×§×‘×•×¦×•×ª!</div>';
      return;
    }

    entries.sort((a, b) => b.total - a.total);
    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

    content.innerHTML = entries.map((e, i) => `
      <div class="lb-row">
        <span class="lb-medal">${medals[i] || `${i + 1}.`}</span>
        <span class="lb-group">×§×‘×•×¦×” ${e.group}</span>
        <span class="lb-score">${e.total} × ×§×³</span>
      </div>
    `).join('');
  }

  if (ROOM) {
    loadSettings();
    renderProgress();
    renderLeaderboard();
    // Sync from Firebase every 5 seconds for cross-device updates
    syncFromFirebase().then(() => { loadSettings(); renderProgress(); renderLeaderboard(); });
    setInterval(() => { syncFromFirebase().then(() => { renderProgress(); renderLeaderboard(); }); }, 5000);
  }
</script>
</body>
</html>
