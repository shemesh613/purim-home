<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âœ¨ ×’×©× ×”××•×ª×™×•×ª â€” ××©×™××ª ×¤×•×¨×™×</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700;900&family=Heebo:wght@300;400;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Heebo', sans-serif; background: #0a0015; color: #fff; overflow: hidden; height: 100vh; width: 100vw; }

    /* â•â• Particles â•â• */
    .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .star { position: absolute; background: #fff; border-radius: 50%; animation: twinkle var(--dur) ease-in-out infinite alternate; }
    @keyframes twinkle { from { opacity: 0.2; transform: scale(0.8); } to { opacity: 1; transform: scale(1.2); } }

    /* â•â• Common Layout â•â• */
    .phase { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.8s, transform 0.8s; }
    .phase.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }

    .station-badge { font-size: 1rem; color: #ffd700; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); padding: 6px 20px; border-radius: 20px; margin-bottom: 15px; letter-spacing: 2px; }
    .title { font-family: 'Frank Ruhl Libre', serif; font-size: clamp(2rem, 6vw, 3.5rem); color: #ffd700; text-shadow: 0 0 30px rgba(255,215,0,0.4); margin-bottom: 10px; }
    .subtitle { font-size: 1.1rem; color: rgba(255,255,255,0.6); margin-bottom: 30px; }
    .btn { font-family: 'Heebo', sans-serif; font-size: 1.2rem; padding: 14px 40px; border: 2px solid #ffd700; background: rgba(255,215,0,0.15); color: #ffd700; border-radius: 12px; cursor: pointer; transition: all 0.3s; letter-spacing: 1px; }
    .btn:hover { background: rgba(255,215,0,0.3); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,215,0,0.3); }

    /* â•â• Phase 1: Color Detection â•â• */
    #phase-color { z-index: 20; }
    .camera-container { position: relative; width: 320px; height: 240px; border-radius: 16px; overflow: hidden; border: 3px solid rgba(255,215,0,0.4); box-shadow: 0 0 30px rgba(139,92,246,0.3); }
    .camera-container video { width: 100%; height: 100%; object-fit: cover; }
    .color-indicator { width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); margin: 20px auto; transition: all 0.5s; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
    .color-status { font-size: 1.3rem; color: rgba(255,255,255,0.7); margin-top: 10px; min-height: 2em; }
    .color-matched { animation: colorPulse 0.5s ease-out; }
    @keyframes colorPulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    .accept-color-label { font-size: 0.9rem; color: rgba(255,215,0,0.5); margin-top: 8px; }

    /* â•â• Phase 2: Matrix Letters â•â• */
    #phase-puzzle { background: #000; flex-direction: column; justify-content: flex-end; padding-bottom: 0; }
    #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; }

    .puzzle-ui {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 20;
      background: linear-gradient(to top, rgba(0,0,0,0.97) 60%, transparent);
      padding: 20px 20px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    .puzzle-question {
      font-family: 'Frank Ruhl Libre', serif;
      font-size: 1.4rem;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255,215,0,0.6);
      text-align: center;
    }
    .answer-row {
      display: flex;
      align-items: center;
      gap: 12px;
      direction: rtl;
    }
    #answer-input {
      font-family: 'Frank Ruhl Libre', serif;
      font-size: 1.6rem;
      background: rgba(139,92,246,0.15);
      border: 2px solid rgba(139,92,246,0.5);
      color: #fff;
      border-radius: 10px;
      padding: 10px 18px;
      width: 200px;
      text-align: center;
      direction: rtl;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #answer-input:focus {
      border-color: rgba(255,215,0,0.7);
      box-shadow: 0 0 20px rgba(255,215,0,0.3);
    }
    #answer-input.error {
      border-color: #f87171;
      animation: shake 0.4s ease-out;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }
    .submit-btn {
      font-family: 'Heebo', sans-serif;
      font-size: 1.1rem;
      padding: 10px 28px;
      border: 2px solid #8b5cf6;
      background: rgba(139,92,246,0.2);
      color: #c4b5fd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }
    .submit-btn:hover { background: rgba(139,92,246,0.4); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139,92,246,0.4); }

    #feedback-msg {
      font-size: 1.1rem;
      min-height: 1.5em;
      text-align: center;
      transition: all 0.3s;
    }
    #hint-box {
      background: rgba(255,215,0,0.08);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 0.95rem;
      color: rgba(255,215,0,0.85);
      text-align: center;
      max-width: 460px;
      display: none;
    }
    .red-flash {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(248,65,65,0.18);
      z-index: 19;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
    }
    .red-flash.active { opacity: 1; }

    /* â•â• Phase 3: Success â•â• */
    #phase-success { background: radial-gradient(ellipse at center, #1a0a3e 0%, #0a0015 100%); z-index: 30; }
    .success-icon { font-size: 5rem; animation: bounce 1s ease-in-out infinite; }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .success-title { font-family: 'Frank Ruhl Libre', serif; font-size: 2.5rem; color: #ffd700; margin: 15px 0; }
    .clue-box { background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.4); border-radius: 16px; padding: 25px 35px; max-width: 500px; margin: 20px auto; }
    .clue-label { font-size: 0.9rem; color: rgba(255,215,0,0.6); margin-bottom: 10px; }
    .clue-text { font-family: 'Frank Ruhl Libre', serif; font-size: 1.5rem; color: #ffd700; line-height: 1.6; }
    .clue-arrow { font-size: 2rem; margin-top: 15px; animation: arrowPulse 1.5s ease-in-out infinite; }
    @keyframes arrowPulse { 0%,100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(10px); opacity: 1; } }

    /* â•â• Confetti â•â• */
    .confetti { position: fixed; top: -10px; width: 10px; height: 10px; z-index: 31; animation: confettiFall var(--fall-dur) linear forwards; }
    @keyframes confettiFall { to { top: 110vh; transform: rotate(var(--rot)) translateX(var(--drift)); } }

    /* â•â• Reset Button â•â• */
    .reset-btn { position: fixed; bottom: 15px; left: 15px; font-size: 0.75rem; color: rgba(255,255,255,0.15); background: none; border: 1px solid rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 6px; cursor: pointer; z-index: 50; }
    .reset-btn:hover { color: rgba(255,255,255,0.4); border-color: rgba(255,255,255,0.3); }
  
    /* â•â• Phase: Group Selection â•â• */
    #phase-group { z-index: 21; background: radial-gradient(ellipse at center, #1a0a3e 0%, #0a0015 100%); }
    .group-title { font-family: 'Frank Ruhl Libre', serif; font-size: 2.5rem; color: #ffd700; margin-bottom: 10px; }
    .group-subtitle { font-size: 1.1rem; color: rgba(255,255,255,0.6); margin-bottom: 30px; }
    .group-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; max-width: 500px; }
    .group-btn {
      font-family: 'Heebo', sans-serif; font-size: 1.8rem; font-weight: 900;
      width: 80px; height: 80px; border-radius: 50%;
      border: 3px solid rgba(255,215,0,0.4); background: rgba(255,215,0,0.1);
      color: #ffd700; cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center;
    }
    .group-btn:hover { background: rgba(255,215,0,0.3); transform: scale(1.15); box-shadow: 0 0 25px rgba(255,215,0,0.4); }
  </style>
</head>
<body>
  <!-- Stars Background -->
  <div class="stars" id="stars"></div>

  <!-- â•â•â• Phase 1: Color Detection â•â•â• -->
  <div class="phase" id="phase-color">
    <div class="station-badge">âœ¨ ×ª×—× ×” 3</div>
    <div class="title">×’×©× ×”××•×ª×™×•×ª</div>
    <div class="subtitle">×¦×‘×¢×• ×“×£ ×œ×‘×Ÿ ×‘×¦×‘×¢ ×”××ª××™× ×•×”×¨×™××• ×œ××¦×œ××”</div>
    <div class="camera-container">
      <video id="camera" autoplay playsinline muted></video>
      <canvas id="color-canvas" style="display:none"></canvas>
    </div>
    <div class="color-indicator" id="color-indicator"></div>
    <div class="color-status" id="color-status">×××ª×™×Ÿ ×œ××¦×œ××”...</div>
    <div class="accept-color-label" id="accept-label"></div>
  </div>

  <!-- â•â•â• Phase 2: Matrix Letters Puzzle â•â•â• -->
  
  <!-- â•â•â• Phase: Group Selection â•â•â• -->
  <div class="phase hidden" id="phase-group">
    <div class="group-title">ğŸ‘‹ ××” ×”×©× ×©×œ×š?</div>
    <div class="group-subtitle">×›×ª×‘×• ××ª ×”×©× ×•×ª×ª×—×™×œ×•!</div>
    <input id="nameInput" type="text" placeholder="×”×©× ×©×œ×™..." style="font-family:'Heebo',sans-serif; font-size:1.5rem; padding:14px 24px; border:3px solid rgba(255,215,0,0.4); border-radius:14px; background:rgba(255,255,255,0.1); color:#ffd700; text-align:center; width:280px; outline:none;" onkeydown="if(event.key==='Enter')submitName()">
    <br>
    <button class="btn" onclick="submitName()" style="margin-top:15px;">ğŸš€ ×™××œ×œ×”!</button>
    <div id="groupInfo" style="margin-top:12px; font-size:1rem; color:rgba(255,215,0,0.6);"></div>
  </div>

  <div class="phase hidden" id="phase-puzzle">
    <canvas id="matrix-canvas"></canvas>
    <div class="red-flash" id="red-flash"></div>

    <div class="puzzle-ui">
      <div class="puzzle-question" id="puzzle-question"></div>
      <div class="answer-row">
        <button class="submit-btn" onclick="checkAnswer()">ğŸ”“ ×¤×ª×—</button>
        <input type="text" id="answer-input" placeholder="×”×§×œ×™×“×• ×›××Ÿ..." maxlength="10" autocomplete="off" autocorrect="off" spellcheck="false" />
      </div>
      <div id="feedback-msg"></div>
      <div id="hint-box"></div>
    </div>
  </div>

  <!-- â•â•â• Phase 3: Success â•â•â• -->
  <div class="phase hidden" id="phase-success">
    <div class="success-icon">ğŸ‰</div>
    <div class="success-title">×¤×™×¦×—×ª× ××ª ×”×¦×•×¤×Ÿ!</div>
    <div class="clue-box">
      <div class="clue-label">ğŸ“ ×”×¨××– ×œ×©×œ×‘ ×”×‘×:</div>
      <div class="clue-text" id="clue-display"></div>
    </div>
    <div class="clue-arrow">â¬‡ï¸</div>
    <div style="display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; justify-content:center;">
      <a id="back-link" href="index.html" class="btn" style="font-size:1rem; padding:10px 30px; text-decoration:none;">ğŸ  ×—×–×¨×” ×œ×—×“×¨×™×</a>
    </div>
  </div>

  <button class="reset-btn" onclick="resetStation()">××™×¤×•×¡</button>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœï¸ ×”×’×“×¨×•×ª â€” ×¢×¨×›×• ×›××Ÿ ××ª ×”×˜×§×¡×˜×™×!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ROOM = new URLSearchParams(window.location.search).get('room') || '';
    const K = ROOM ? ROOM + '_' : '';
    if (ROOM) { const bl = document.getElementById('back-link'); if (bl) bl.href = 'index.html?room=' + encodeURIComponent(ROOM); }

    const CONFIG = {
      stationNumber: 3,
      stationName: '×’×©× ×”××•×ª×™×•×ª',
      acceptColor: 'green',
      answerWord: '××¨×“×›×™',
      question: '××™ ××¡×ª×ª×¨ ×‘×™×Ÿ ×”××•×ª×™×•×ª?',
      hint: '×’×™×‘×•×¨ ×”××’×™×œ×”, ×¢××“ ×‘×©×¢×¨ ×”××œ×š, ×œ× ×›×¨×¢ ×•×œ× ×”×©×ª×—×•×•×”',
      clueText: '×´××” × ×¢×©×” ×™×§×¨ ×•×’×“×•×œ×” ×œ××¨×“×›×™ ×¢×œ ×›×›×”×´ â€” ×‘×—×“×¨ ×©×‘×• ×™×•×©×‘×™ ×”×©×¨×¨×” ××œ××“×™× ×•××•×¨×™×, ×××—×•×¨×™ ×”×¤×ª×— ×”×’×“×•×œ, ×›×ª×•× ×™××ª×™×Ÿ',
    };

    // â•â• Color definitions â•â•
    const COLORS = {
      red:    { he: '××“×•× ğŸ”´', min: [150, 0, 0], max: [255, 100, 100], bg: '#ff3333' },
      blue:   { he: '×›×—×•×œ ğŸ”µ', min: [0, 0, 140], max: [100, 100, 255], bg: '#3366ff' },
      green:  { he: '×™×¨×•×§ ğŸŸ¢', min: [0, 120, 0], max: [100, 255, 100], bg: '#33cc33' },
      yellow: { he: '×¦×”×•×‘ ğŸŸ¡', min: [180, 180, 0], max: [255, 255, 100], bg: '#ffcc00' },
      orange: { he: '×›×ª×•× ğŸŸ ', min: [200, 100, 0], max: [255, 180, 80], bg: '#ff8800' },
      purple: { he: '×¡×’×•×œ ×‘×”×™×¨ ğŸŸ£', min: [80, 30, 100], max: [230, 180, 255], bg: '#b366ff' },
    };

    // â•â• Stars â•â•
    const starsEl = document.getElementById('stars');
    for (let i = 0; i < 80; i++) {
      const s = document.createElement('div');
      s.className = 'star';
      const size = Math.random() * 3 + 1;
      s.style.cssText = `width:${size}px;height:${size}px;top:${Math.random()*100}%;left:${Math.random()*100}%;--dur:${1+Math.random()*3}s;animation-delay:${Math.random()*3}s;`;
      starsEl.appendChild(s);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Phase 1: Color Detection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const video = document.getElementById('camera');
    const colorCanvas = document.getElementById('color-canvas');
    const colorCtx = colorCanvas.getContext('2d', { willReadFrequently: true });
    const indicator = document.getElementById('color-indicator');
    const statusEl = document.getElementById('color-status');
    const acceptLabel = document.getElementById('accept-label');

    acceptLabel.textContent = `×ª×—× ×” ${CONFIG.stationNumber}`;
    let colorDetected = false;
    let matchCount = 0;

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 320, height: 240 } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          colorCanvas.width = 320;
          colorCanvas.height = 240;
          statusEl.textContent = 'ğŸ¨ ×¦×‘×¢×• ×“×£ ×œ×‘×Ÿ ×‘×¦×‘×¢ ×”× ×›×•×Ÿ ×•×”×¨×™××• ×œ××¦×œ××”';
          detectColor();
        };
      } catch (e) {
        statusEl.textContent = 'âš ï¸ ××™×Ÿ ×’×™×©×” ×œ××¦×œ××” â€” ×œ×—×¦×• ×¢×œ "××¤×©×¨"';
      }
    }

    function detectColor() {
      if (colorDetected) return;
      colorCtx.drawImage(video, 0, 0, 320, 240);
      const cx = 110, cy = 70, cw = 100, ch = 100;
      const imageData = colorCtx.getImageData(cx, cy, cw, ch);
      const data = imageData.data;
      let rSum = 0, gSum = 0, bSum = 0, count = 0;
      for (let i = 0; i < data.length; i += 4) {
        rSum += data[i]; gSum += data[i+1]; bSum += data[i+2]; count++;
      }
      const r = Math.round(rSum / count);
      const g = Math.round(gSum / count);
      const b = Math.round(bSum / count);
      indicator.style.background = `rgb(${r},${g},${b})`;

      let detected = null;
      for (const [name, col] of Object.entries(COLORS)) {
        if (r >= col.min[0] && r <= col.max[0] && g >= col.min[1] && g <= col.max[1] && b >= col.min[2] && b <= col.max[2]) {
          detected = name;
          break;
        }
      }

      if (detected === CONFIG.acceptColor) {
        matchCount++;
        statusEl.textContent = `ğŸ¯ ××–×”×” ${COLORS[detected].he}... (${matchCount}/10)`;
        statusEl.style.color = '#4ade80';
        if (matchCount >= 10) {
          colorDetected = true;
          indicator.classList.add('color-matched');
          statusEl.textContent = `âœ… ${COLORS[detected].he} â€” ×–×•×”×”! × ×›× ×¡×™×...`;
          setTimeout(showGroupSelect, 1200);
          return;
        }
      } else if (detected) {
        matchCount = Math.max(0, matchCount - 1);
        statusEl.textContent = `âŒ ×–×” ${COLORS[detected].he} â€” ×œ× ×”×¦×‘×¢ ×”× ×›×•×Ÿ â€” × ×¡×• ×ª×—× ×” ××—×¨×ª`;
        statusEl.style.color = '#f87171';
      } else {
        matchCount = Math.max(0, matchCount - 1);
        // Check if something colorful is visible (not just gray/dark)
        const maxC = Math.max(r, g, b);
        const minC = Math.min(r, g, b);
        const saturation = maxC > 30 ? (maxC - minC) / maxC : 0;
        if (saturation > 0.25 && maxC > 60) {
          statusEl.textContent = 'ğŸ” ××–×”×” ×¦×‘×¢... ×§×¨×‘×• ××ª ×”×“×£ ×”×¦×‘×•×¢ ×œ××¦×œ××”';
          statusEl.style.color = '#fbbf24';
        } else {
          statusEl.textContent = 'ğŸ¨ ×¦×‘×¢×• ×“×£ ×œ×‘×Ÿ ×‘×¦×‘×¢ ×”× ×›×•×Ÿ ×•×”×¨×™××• ×œ××¦×œ××”';
          statusEl.style.color = 'rgba(255,255,255,0.7)';
        }
      }
      requestAnimationFrame(detectColor);
    }

    startCamera();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Phase 2: Matrix Hebrew Letters
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const matrixCanvas = document.getElementById('matrix-canvas');
    const mCtx = matrixCanvas.getContext('2d');

    // Full Hebrew alphabet + extras for rain
    const HEBREW_CHARS = '××‘×’×“×”×•×–×—×˜×™×›×œ×× ×¡×¢×¤×¦×§×¨×©×ª××Ÿ×£×š×¥';
    const ANSWER = CONFIG.answerWord; // ××¨×“×›×™

    let columns = [];
    let frameCount = 0;
    let matrixAnimId = null;
    let wrongAttempts = 0;
    let puzzleSolved = false;
    let puzzleStartTime = 0;

    // Each column: { y, speed, chars[], goldenTimer, isAnswerCol, answerLetterIdx }
    function initMatrix() {
      matrixCanvas.width = window.innerWidth;
      matrixCanvas.height = window.innerHeight;

      const FONT_SIZE = 22;
      const numCols = Math.floor(matrixCanvas.width / FONT_SIZE);

      columns = [];
      for (let i = 0; i < numCols; i++) {
        columns.push({
          x: i * FONT_SIZE,
          y: Math.random() * -matrixCanvas.height, // start above screen at random heights
          speed: 0.5 + Math.random() * 1.2,
          chars: Array.from({ length: 30 }, () => randomHebChar()),
          charTimer: 0,
          charSwapInterval: 4 + Math.floor(Math.random() * 8),
          // golden state: null | { letter, brightness, size }
          goldenState: null,
          goldenTimer: 0,
        });
      }
    }

    function randomHebChar() {
      return HEBREW_CHARS[Math.floor(Math.random() * HEBREW_CHARS.length)];
    }

    // Schedule word flashes
    // answerCols: which column indices are currently showing answer letters
    let nextSingleFlash = 60;     // frame when next single golden letter appears
    let nextWordFlash   = 120;    // frame when full word appears
    const FONT_SIZE = 22;

    function drawMatrix() {
      if (puzzleSolved) return;
      frameCount++;

      const W = matrixCanvas.width;
      const H = matrixCanvas.height;

      // Dim previous frame (trail effect) â€” faster fade so golden pops
      mCtx.fillStyle = 'rgba(0, 0, 0, 0.08)';
      mCtx.fillRect(0, 0, W, H);

      // â”€â”€ Single golden letter flash â”€â”€
      if (frameCount >= nextSingleFlash) {
        const letter = ANSWER[Math.floor(Math.random() * ANSWER.length)];
        const colIdx = Math.floor(Math.random() * columns.length);
        columns[colIdx].goldenState = { letter, brightness: 1.0, size: 2.2 };
        columns[colIdx].goldenTimer = 120; // show longer
        nextSingleFlash = frameCount + 50 + Math.floor(Math.random() * 40);
      }

      // â”€â”€ Full word flash across adjacent columns â”€â”€
      if (frameCount >= nextWordFlash) {
        // Pick a start column so the whole word fits â€” center it
        const startCol = Math.floor((columns.length - ANSWER.length) / 2) + Math.floor(Math.random() * 5 - 2);
        const safeStart = Math.max(0, Math.min(startCol, columns.length - ANSWER.length));
        for (let i = 0; i < ANSWER.length; i++) {
          const c = columns[safeStart + i];
          if (c) {
            c.goldenState = { letter: ANSWER[i], brightness: 1.0, size: 2.8 };
            c.goldenTimer = 150; // show much longer
          }
        }
        nextWordFlash = frameCount + 120 + Math.floor(Math.random() * 50);
      }

      // â”€â”€ Draw each column â”€â”€
      for (let ci = 0; ci < columns.length; ci++) {
        const col = columns[ci];

        // Advance column position
        col.y += col.speed;
        if (col.y > H + 200) {
          col.y = -FONT_SIZE * (5 + Math.random() * 20);
          col.speed = 0.5 + Math.random() * 1.2;
        }

        // Swap chars occasionally
        col.charTimer++;
        if (col.charTimer >= col.charSwapInterval) {
          col.charTimer = 0;
          const idx = Math.floor(Math.random() * col.chars.length);
          col.chars[idx] = randomHebChar();
          col.charSwapInterval = 4 + Math.floor(Math.random() * 8);
        }

        // Draw the falling stream
        const streamLen = col.chars.length;
        for (let row = 0; row < streamLen; row++) {
          const posY = col.y - row * FONT_SIZE;
          if (posY < -FONT_SIZE || posY > H) continue;

          // Head of stream: bright purple
          if (row === 0) {
            mCtx.font = `bold ${FONT_SIZE}px monospace`;
            mCtx.fillStyle = 'rgba(200,180,255,0.9)';
          } else {
            // Tail fades: from medium to very dim purple
            const alpha = Math.max(0.03, 0.55 - row * 0.025);
            mCtx.font = `${FONT_SIZE}px monospace`;
            mCtx.fillStyle = `rgba(139,92,246,${alpha})`;
          }
          mCtx.fillText(col.chars[row], col.x, posY);
        }

        // Draw golden letter on top if active
        if (col.goldenState && col.goldenTimer > 0) {
          const gs = col.goldenState;
          col.goldenTimer--;

          // Pulsing brightness
          const pulse = 0.7 + 0.3 * Math.sin(col.goldenTimer * 0.3);
          const alpha = gs.brightness * pulse;
          const fontSize = Math.round(FONT_SIZE * gs.size);

          mCtx.save();
          mCtx.font = `bold ${fontSize}px monospace`;

          // Outer glow â€” extra bright
          mCtx.shadowColor = '#ffd700';
          mCtx.shadowBlur = 30 + pulse * 20;
          mCtx.fillStyle = `rgba(255, 215, 0, ${Math.min(1, alpha * 1.3)})`;

          // Center the larger glyph in the column
          const offset = (fontSize - FONT_SIZE) / 2;
          mCtx.fillText(gs.letter, col.x - offset * 0.3, col.y - offset * 0.5);
          mCtx.shadowBlur = 0;
          mCtx.restore();

          if (col.goldenTimer <= 0) {
            col.goldenState = null;
          }
        }
      }

      matrixAnimId = requestAnimationFrame(drawMatrix);
    }
    // â•â• Group & Member Selection â•â•
    let selectedGroup = null;
    let selectedMember = null;
    const settings = JSON.parse(localStorage.getItem(K + 'purim_settings') || '{"numGroups":10,"groupSize":4}');

    function showGroupSelect() {
      if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
      document.getElementById('phase-color').classList.add('hidden');
      document.getElementById('phase-group').classList.remove('hidden');
      setTimeout(() => document.getElementById('nameInput').focus(), 300);
    }

    function submitName() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) { alert('×›×ª×‘×• ××ª ×”×©× ×©×œ×›×!'); return; }
      let hash = 0;
      for (let i = 0; i < name.length; i++) { hash = ((hash << 5) - hash) + name.charCodeAt(i); hash |= 0; }
      selectedGroup = (Math.abs(hash) % settings.numGroups) + 1;
      selectedMember = name;
      document.getElementById('groupInfo').textContent = `×§×‘×•×¦×” ${selectedGroup} â€” ×‘×”×¦×œ×—×” ${name}! ğŸ¯`;
      setTimeout(() => { document.getElementById('phase-group').classList.add('hidden'); startPuzzle(); }, 800);
    }

    function saveCompletion() {
      if (!selectedGroup || !selectedMember) return;
      const key = K + 'purim_progress';
      const data = JSON.parse(localStorage.getItem(key) || '{}');
      if (!data[selectedGroup]) data[selectedGroup] = {};
      if (!data[selectedGroup][selectedMember]) data[selectedGroup][selectedMember] = [];
      if (!data[selectedGroup][selectedMember].includes(CONFIG.stationNumber)) {
        data[selectedGroup][selectedMember].push(CONFIG.stationNumber);
      }
      localStorage.setItem(key, JSON.stringify(data));
    }

    function saveScore() {
      if (!selectedGroup) return;
      const elapsed = Math.floor((Date.now() - puzzleStartTime) / 1000);
      const score = Math.max(100 - elapsed, 10);
      const scores = JSON.parse(localStorage.getItem(K + 'purim_scores') || '{}');
      const g = String(selectedGroup);
      if (!scores[g]) scores[g] = {};
      scores[g][CONFIG.stationNumber] = Math.max(scores[g][CONFIG.stationNumber] || 0, score);
      localStorage.setItem(K + 'purim_scores', JSON.stringify(scores));
    }

    function startPuzzle() {
      if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
      document.getElementById('phase-color').classList.add('hidden');
      document.getElementById('phase-puzzle').classList.remove('hidden');
      document.getElementById('puzzle-question').textContent = CONFIG.question;
      puzzleStartTime = Date.now();

      initMatrix();
      frameCount = 0;
      nextSingleFlash = 60;
      nextWordFlash   = 120;
      drawMatrix();

      // Focus input
      setTimeout(() => document.getElementById('answer-input').focus(), 400);
    }

    window.addEventListener('resize', () => {
      if (!document.getElementById('phase-puzzle').classList.contains('hidden')) {
        initMatrix();
      }
    });

    // Allow Enter key to submit
    document.getElementById('answer-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkAnswer();
    });

    // â”€â”€ Answer checking â”€â”€
    function checkAnswer() {
      if (puzzleSolved) return;
      const input = document.getElementById('answer-input');
      const val = input.value.trim();
      const feedbackEl = document.getElementById('feedback-msg');

      if (val === CONFIG.answerWord) {
        puzzleSolved = true;
        if (matrixAnimId) cancelAnimationFrame(matrixAnimId);
        feedbackEl.style.color = '#4ade80';
        feedbackEl.textContent = 'âœ… × ×›×•×Ÿ!';
        setTimeout(showSuccess, 800);
      } else {
        wrongAttempts++;
        // Red flash overlay
        const flash = document.getElementById('red-flash');
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 300);

        // Shake input
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 450);
        input.value = '';

        feedbackEl.style.color = '#f87171';
        feedbackEl.textContent = 'âŒ × ×¡×• ×©×•×‘!';
        setTimeout(() => { if (!puzzleSolved) feedbackEl.textContent = ''; }, 2000);

        // Show hint after 3 wrong attempts
        if (wrongAttempts >= 3) {
          const hintBox = document.getElementById('hint-box');
          hintBox.textContent = `ğŸ’¡ ${CONFIG.hint}`;
          hintBox.style.display = 'block';
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Phase 3: Success
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showSuccess() {
      saveCompletion();
      saveScore();
      document.getElementById('phase-puzzle').classList.add('hidden');
      document.getElementById('phase-success').classList.remove('hidden');
      document.getElementById('clue-display').textContent = CONFIG.clueText;
      spawnConfetti();
    }

    function spawnConfetti() {
      const colors = ['#ffd700', '#ff3366', '#33ccff', '#33ff66', '#ff8800', '#cc33ff'];
      for (let i = 0; i < 60; i++) {
        setTimeout(() => {
          const c = document.createElement('div');
          c.className = 'confetti';
          c.style.cssText = `left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'2px'};--fall-dur:${2+Math.random()*3}s;--rot:${Math.random()*720}deg;--drift:${-50+Math.random()*100}px;`;
          document.body.appendChild(c);
          setTimeout(() => c.remove(), 5000);
        }, i * 50);
      }
    }

    function resetStation() {
      // Cancel animation
      if (matrixAnimId) { cancelAnimationFrame(matrixAnimId); matrixAnimId = null; }

      // Reset state
      colorDetected = false;
      matchCount = 0;
      puzzleSolved = false;
      wrongAttempts = 0;
      frameCount = 0;

      // Reset UI
      document.getElementById('phase-success').classList.add('hidden');
      document.getElementById('phase-puzzle').classList.add('hidden');
      document.getElementById('phase-color').classList.remove('hidden');
      document.getElementById('answer-input').value = '';
      document.getElementById('feedback-msg').textContent = '';
      document.getElementById('hint-box').style.display = 'none';
      document.getElementById('hint-box').textContent = '';
      document.getElementById('red-flash').classList.remove('active');

      statusEl.textContent = 'ğŸ¨ ×¦×‘×¢×• ×“×£ ×œ×‘×Ÿ ×‘×¦×‘×¢ ×”× ×›×•×Ÿ ×•×”×¨×™××• ×œ××¦×œ××”';
      statusEl.style.color = 'rgba(255,255,255,0.7)';
      indicator.classList.remove('color-matched');
      indicator.style.background = '';

      // Clear canvas
      if (matrixCanvas.width) mCtx.clearRect(0, 0, matrixCanvas.width, matrixCanvas.height);

      startCamera();
    }
  </script>
</body>
</html>
